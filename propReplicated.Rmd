---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}

# Use this code (from the devtools package) to source C-3PR directly from GitHub:
require(devtools)
#install.packages('devtools')
#install.packages('RCurl')
library(devtools)
source_url('https://raw.githubusercontent.com/FredHasselman/toolboxR/master/C-3PR.R')

# This will load and (if necessary) install libraries frequently used for data management and plotting
in.IT(c('ggplot2','RColorBrewer','lattice','gridExtra','plyr','dplyr','httr'))

# Read the data from the OSF storage
# Note: get.OSFfile() returns a list with the .csv data (df) and information (info) containing the URL download timestamp and original column and rownames (these names will be changed if dfCln=TRUE).  
RPPdata <- get.OSFfile(code='https://osf.io/fgjvw/',dfCln=T)$df

## If you dowloaded the csv file to your harddrive use this code:
#  RPPdata<-read.csv('rpp_data.csv',stringsAsFactors=F )
#  RPPdata<-df.Clean(RPPdata)
#  RPPdata<-RPPdata$df

# Select the completed replication studies
RPPdata <- dplyr::filter(RPPdata, !is.na(T.pval.USE.O),!is.na(T.pval.USE.R))
# We have 99 studies for which p-values and effect sizes could be calculated
nrow(RPPdata)
# We have 97 studies for which p-values of the original effect were significantly below .05
idOK <- complete.cases(RPPdata$T.r.O,RPPdata$T.r.R)
sum(idOK)

# Get ggplot2 themes predefined in C-3PR
mytheme <- gg.theme("clean")
```

```{r}
# Equal sized windows
stepsize = 0.0025
winsize = 0.005
origP = RPPdata$T.pval.USE.O
replicP = RPPdata$T.pval.USE.R
startwins = seq(0,0.05-stepsize,by=stepsize)
winProps <- 0
i=0
for (startw in startwins){
  i=i+1
  endw = startw + winsize
  inds = origP>=startw & origP<endw
  origPs = origP[inds]
  replicPs = replicP[inds]
  winProps[i] = sum(replicPs<0.05)/length(replicPs)
}

eqwin_df = data.frame(startwins, winProps)


pdf("/Users/vishnusreekumar/Dropbox/PostdocAnalysis/Alpha005/Figs/propReplicated_eqwin005_step0025.pdf")

ggplot(eqwin_df,aes(x=startwins,y=winProps))+ geom_point() +
  geom_line()+scale_x_continuous(breaks=c(0,.01,.05),limits=c(0,.06)) + 
  ggtitle("") + xlab("Original Study p-value") + ylab("Proportion of studies replicated") + 
  ylim(c(0,1)) + 
  geom_vline(aes(xintercept=0.05),linetype=2,color=mypalette[9]) + 
  geom_vline(aes(xintercept=0.005),linetype=2,color=mypalette[9]) + 
  mytheme
dev.off()
```

```{r}
### Calculate proportion of studies replicated in moving windows over original study p-values. ###
### Take window of size winsize, calculate proportion of studies replicated within that window.###
### Move window ahead by stepsize. Plot proportion against starting positions of these windows ###

## Download toolboxR: https://github.com/FredHasselman/toolboxR
## Original analysis code to make figures: https://osf.io/tfbe8/

# Use this code (from the devtools package) to source C-3PR directly from GitHub:
require(devtools)
#install.packages('devtools')
#install.packages('RCurl')
library(devtools)
source_url('https://raw.githubusercontent.com/FredHasselman/toolboxR/master/C-3PR.R')

# This will load and (if necessary) install libraries frequently used for data management and plotting
in.IT(c('ggplot2','RColorBrewer','lattice','gridExtra','plyr','dplyr','httr'))

# Read the data from the OSF storage
# Note: get.OSFfile() returns a list with the .csv data (df) and information (info) containing the URL download timestamp and original column and rownames (these names will be changed if dfCln=TRUE).  
RPPdata <- get.OSFfile(code='https://osf.io/fgjvw/',dfCln=T)$df

## If you dowloaded the csv file to your harddrive use this code:
#  RPPdata<-read.csv('rpp_data.csv',stringsAsFactors=F )
#  RPPdata<-df.Clean(RPPdata)
#  RPPdata<-RPPdata$df

# Select the completed replication studies
RPPdata <- dplyr::filter(RPPdata, !is.na(T.pval.USE.O),!is.na(T.pval.USE.R))
# We have 99 studies for which p-values and effect sizes could be calculated
nrow(RPPdata)
# We have 97 studies for which p-values of the original effect were significantly below .05
idOK <- complete.cases(RPPdata$T.r.O,RPPdata$T.r.R)
sum(idOK)

# Get ggplot2 themes predefined in C-3PR
mytheme <- gg.theme("clean")



###########################
## V.Sreekumar modified: ##
###########################

# Equal sized windows
stepsize = 0.0025
winsize = 0.005
origP = RPPdata$T.pval.USE.O
replicP = RPPdata$T.pval.USE.R
startwins = seq(0,0.05-stepsize,by=stepsize)
winProps <- 0
i=0
for (startw in startwins){
  i=i+1
  endw = startw + winsize
  inds = origP>=startw & origP<endw
  origPs = origP[inds]
  replicPs = replicP[inds]
  winProps[i] = sum(replicPs<0.05)/length(replicPs)
}

eqwin_df = data.frame(startwins, winProps)


pdf("propReplicated_eqwin005_step0025.pdf")

ggplot(eqwin_df,aes(x=startwins,y=winProps))+ geom_point() +
  geom_line()+scale_x_continuous(breaks=c(0,.01,.05),limits=c(0,.06)) + 
  ggtitle("") + xlab("Original Study p-value") + ylab("Proportion of studies replicated") + 
  ylim(c(0,1)) + 
  geom_vline(aes(xintercept=0.05),linetype=2,color=mypalette[9]) + 
  geom_vline(aes(xintercept=0.005),linetype=2,color=mypalette[9]) + 
  mytheme
dev.off()
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
